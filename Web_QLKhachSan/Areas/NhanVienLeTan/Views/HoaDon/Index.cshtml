@model Web_QLKhachSan.Areas.NhanVienLeTan.ViewModels.HoaDon.HoaDonListViewModel
@{
    ViewBag.Title = "Quản Lý Hóa Đơn";
    Layout = "~/Areas/NhanVienLeTan/Views/Shared/_LayoutNVLT.cshtml";
}

@section styles {
    <!-- Custom CSS for Hóa Đơn Index -->
    <link href="@Url.Content("~/Areas/NhanVienLeTan/assets/css/hoaDonIndex.css")" rel="stylesheet" />
}

<div class="container-fluid">
    @* ==== HEADER ==== *@
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-file-invoice-dollar"></i> Quản Lý Hóa Đơn
        </h1>
    </div>

    @* ==== THÔNG BÁO ==== *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
      </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
         <span aria-hidden="true">&times;</span>
  </button>
     </div>
    }

    @* ==== THỐNG KÊ NHANH ==== *@
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="card border-left-primary shadow h-100 py-2 stat-card">
             <div class="card-body">
      <div class="row no-gutters align-items-center">
       <div class="col mr-2">
          <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Tổng hóa đơn</div>
   <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.TongHoaDon</div>
       </div>
        <div class="col-auto">
      <i class="fas fa-file-invoice fa-2x text-gray-300"></i>
     </div>
     </div>
  </div>
     </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-warning shadow h-100 py-2 stat-card">
  <div class="card-body">
                    <div class="row no-gutters align-items-center">
             <div class="col mr-2">
         <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Chưa thanh toán</div>
          <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.ChuaThanhToan</div>
     </div>
           <div class="col-auto">
          <i class="fas fa-clock fa-2x text-gray-300"></i>
     </div>
</div>
  </div>
</div>
     </div>

        <div class="col-xl-3 col-md-6 mb-3">
       <div class="card border-left-success shadow h-100 py-2 stat-card">
       <div class="card-body">
       <div class="row no-gutters align-items-center">
         <div class="col mr-2">
           <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Đã thanh toán</div>
        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.DaThanhToan</div>
             </div>
   <div class="col-auto">
<i class="fas fa-check-circle fa-2x text-gray-300"></i>
              </div>
         </div>
            </div>
    </div>
  </div>

   <div class="col-xl-3 col-md-6 mb-3">
   <div class="card border-left-info shadow h-100 py-2 stat-card">
         <div class="card-body">
         <div class="row no-gutters align-items-center">
   <div class="col mr-2">
       <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Doanh thu hôm nay</div>
         <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.DoanhThuHomNay.ToString("N0")đ</div>
    </div>
  <div class="col-auto">
             <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
        </div>
       </div>
    </div>
   </div>
        </div>
    </div>

    @* ==== BỘ LỌC ==== *@
    <div class="card shadow-sm mb-4 filter-card">
        <div class="card-header py-3">
   <h6 class="m-0 font-weight-bold text-white">
                <i class="fas fa-filter"></i> Bộ Lọc & Tìm Kiếm
            </h6>
        </div>
  <div class="card-body p-4">
      @using (Html.BeginForm("Index", "HoaDon", FormMethod.Get, new { @class = "filter-form" }))
       {
                <div class="form-row mb-4">
         <div class="col-12">
       <label class="form-label">
 <i class="fas fa-search text-primary"></i>
     <strong>Tìm kiếm</strong>
               </label>
 @Html.TextBox("TimKiem", Model.Filter.TimKiem, new
            {
  @class = "form-control form-control-lg",
                placeholder = "Nhập mã hóa đơn, tên khách hàng, số điện thoại, mã đặt phòng...",
         autocomplete = "off"
     })
       </div>
  </div>

                <div class="form-row">
        <div class="col-lg-3 col-md-6 mb-3">
      <label class="form-label">
   <i class="fas fa-info-circle text-primary"></i>
   <strong>Trạng thái</strong>
               </label>
               @Html.DropDownList("TrangThaiHoaDon",
      new SelectList(new[]
      {
   new { Value = (byte)0, Text = "Chưa thanh toán" },
    new { Value = (byte)1, Text = "Đã thanh toán" }
        }, "Value", "Text", Model.Filter.TrangThaiHoaDon),
           "-- Tất cả --",
  new { @class = "form-control custom-select" })
               </div>

  <div class="col-lg-3 col-md-6 mb-3">
        <label class="form-label">
        <i class="fas fa-credit-card text-primary"></i>
        <strong>Phương thức TT</strong>
     </label>
   @Html.DropDownList("PhuongThucThanhToan",
       new SelectList(new[]
                 {
        new { Value = "Tiền mặt", Text = "Tiền mặt" },
          new { Value = "Chuyển khoản", Text = "Chuyển khoản" },
       new { Value = "Online", Text = "Online" }
     }, "Value", "Text", Model.Filter.PhuongThucThanhToan),
            "-- Tất cả --",
         new { @class = "form-control custom-select" })
     </div>

<div class="col-lg-3 col-md-6 mb-3">
              <label class="form-label">
   <i class="fas fa-calendar text-primary"></i>
          <strong>Từ ngày</strong>
          </label>
           @Html.TextBox("TuNgay", Model.Filter.TuNgay?.ToString("yyyy-MM-dd"), new
             {
     @class = "form-control",
    type = "date"
          })
  </div>

   <div class="col-lg-3 col-md-6 mb-3">
           <label class="form-label">
                 <i class="fas fa-calendar text-primary"></i>
     <strong>Đến ngày</strong>
            </label>
             @Html.TextBox("DenNgay", Model.Filter.DenNgay?.ToString("yyyy-MM-dd"), new
 {
               @class = "form-control",
       type = "date"
              })
               </div>
   </div>

       <div class="form-row">
           <div class="col-lg-6 col-md-6 mb-3">
   <label class="form-label">
         <i class="fas fa-dollar-sign text-primary"></i>
         <strong>Từ số tiền</strong>
       </label>
          @Html.TextBox("TuSoTien", Model.Filter.TuSoTien, new
            {
  @class = "form-control",
         type = "number",
               min = "0",
   step = "1000",
           placeholder = "0đ"
            })
         </div>

       <div class="col-lg-6 col-md-6 mb-3">
              <label class="form-label">
     <i class="fas fa-dollar-sign text-primary"></i>
     <strong>Đến số tiền</strong>
  </label>
     @Html.TextBox("DenSoTien", Model.Filter.DenSoTien, new
    {
    @class = "form-control",
   type = "number",
       min = "0",
 step = "1000",
       placeholder = "999,999,999đ"
      })
    </div>
       </div>

    <div class="form-row">
           <div class="col-12">
            <div class="d-flex gap-2 flex-wrap">
    <button type="submit" class="btn btn-primary px-4">
                <i class="fas fa-search"></i> Tìm kiếm
     </button>
           <a href="@Url.Action("Index", "HoaDon")" class="btn btn-secondary px-4">
           <i class="fas fa-redo"></i> Làm mới
       </a>
 </div>
        </div>
    </div>
        }
        </div>
    </div>

  @* ==== DANH SÁCH HÓA ĐƠN ==== *@
    <div class="card shadow mb-4">
  <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
       <i class="fas fa-table"></i> Danh sách hóa đơn
  <span class="badge badge-primary ml-2">@Model.TotalRecords hóa đơn</span>
   </h6>
        </div>
        <div class="card-body">
  @if (Model.DanhSachHoaDon != null && Model.DanhSachHoaDon.Any())
       {
        <div class="table-responsive">
     <table class="table table-bordered table-hover" width="100%" cellspacing="0">
          <thead class="thead-light">
            <tr>
      <th>Mã HĐ</th>
 <th>Ngày lập</th>
     <th>Khách hàng</th>
                 <th>Mã đặt phòng</th>
 <th>Tổng tiền</th>
     <th>Trạng thái</th>
       <th>Phương thức TT</th>
   <th>Thao tác</th>
    </tr>
        </thead>
        <tbody>
                @foreach (var item in Model.DanhSachHoaDon)
    {
      <tr>
  <td>
         <strong>@item.MaHoaDon</strong>
 </td>
            <td>
         @item.NgayLap.ToString("dd/MM/yyyy")<br />
          <small class="text-muted">@item.NgayLap.ToString("HH:mm")</small>
        </td>
 <td>
 <strong>@item.TenKhachHang</strong><br />
        <small class="text-muted">@item.SoDienThoaiKhachHang</small>
   </td>
      <td>
                 @if (!string.IsNullOrEmpty(item.MaDatPhong))
    {
         <span class="badge badge-info">@item.MaDatPhong</span>
        }
      else
     {
       <span class="text-muted">-</span>
        }
           </td>
        <td class="text-right">
   <strong class="price-display">@(item.TongTien.HasValue ? item.TongTien.Value.ToString("N0") + "đ" : "0đ")</strong>
        </td>
 <td class="text-center">
       <span class="badge badge-status" style="background-color: @item.TrangThaiHoaDonColor; color: white;">
    @item.TrangThaiHoaDonText
               </span>
              </td>
             <td>
       @if (!string.IsNullOrEmpty(item.PhuongThucThanhToan))
{
          <span class="badge badge-secondary">@item.PhuongThucThanhToan</span>
          }
          else
                 {
         <span class="text-muted">Chưa TT</span>
  }
</td>
           <td class="action-buttons text-center">
         <a href="@Url.Action("Details", new { id = item.HoaDonId })" class="btn btn-sm btn-info" title="Xem chi tiết">
         <i class="fas fa-eye"></i>
     </a>
          @if (item.TrangThaiHoaDon == 0)
     {
          <button type="button" class="btn btn-sm btn-success"
   onclick="showThanhToanModal(@item.HoaDonId, '@item.MaHoaDon', @item.TongTien)"
 title="Thanh toán">
       <i class="fas fa-money-bill-wave"></i>
     </button>
   }
  </td>
     </tr>
          }
        </tbody>
 </table>
           </div>

        @* ==== PAGINATION ==== *@
       if (Model.TotalPages > 1)
     {
  <nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
       <a class="page-link" href="@Url.Action("Index", new
           {
    TimKiem = Model.Filter.TimKiem,
        TrangThaiHoaDon = Model.Filter.TrangThaiHoaDon,
   PhuongThucThanhToan = Model.Filter.PhuongThucThanhToan,
        TuNgay = Model.Filter.TuNgay,
    DenNgay = Model.Filter.DenNgay,
         TuSoTien = Model.Filter.TuSoTien,
        DenSoTien = Model.Filter.DenSoTien,
        CurrentPage = Model.CurrentPage - 1
           })">
              <i class="fas fa-chevron-left"></i> Trước
</a>
     </li>

   @for (int i = 1; i <= Model.TotalPages; i++)
        {
     <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
    <a class="page-link" href="@Url.Action("Index", new
                {
TimKiem = Model.Filter.TimKiem,
              TrangThaiHoaDon = Model.Filter.TrangThaiHoaDon,
          PhuongThucThanhToan = Model.Filter.PhuongThucThanhToan,
        TuNgay = Model.Filter.TuNgay,
    DenNgay = Model.Filter.DenNgay,
       TuSoTien = Model.Filter.TuSoTien,
           DenSoTien = Model.Filter.DenSoTien,
    CurrentPage = i
      })">@i</a>
   </li>
      }

           <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
       <a class="page-link" href="@Url.Action("Index", new
        {
          TimKiem = Model.Filter.TimKiem,
      TrangThaiHoaDon = Model.Filter.TrangThaiHoaDon,
      PhuongThucThanhToan = Model.Filter.PhuongThucThanhToan,
      TuNgay = Model.Filter.TuNgay,
             DenNgay = Model.Filter.DenNgay,
          TuSoTien = Model.Filter.TuSoTien,
          DenSoTien = Model.Filter.DenSoTien,
    CurrentPage = Model.CurrentPage + 1
      })">
  Sau <i class="fas fa-chevron-right"></i>
        </a>
            </li>
       </ul>
          </nav>

           <p class="text-center text-muted">
        Trang @Model.CurrentPage / @Model.TotalPages - Tổng @Model.TotalRecords hóa đơn
  </p>
       }
            }
        else
            {
     <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Không có hóa đơn nào phù hợp với điều kiện lọc.
        </div>
        }
        </div>
    </div>
</div>

@* ==== MODAL THANH TOÁN ==== *@
<div class="modal fade" id="thanhToanModal" tabindex="-1" role="dialog" aria-labelledby="thanhToanModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
 <div class="modal-content">
            <div class="modal-header bg-primary">
          <h5 class="modal-title text-white" id="thanhToanModalLabel">
               <i class="fas fa-money-bill-wave"></i> Thanh Toán Hóa Đơn
          </h5>
    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
           <span aria-hidden="true">&times;</span>
      </button>
       </div>
      <div class="modal-body">
    <div class="text-center mb-3">
             <h4>Hóa đơn: <span id="modalMaHoaDon" class="text-primary"></span></h4>
        <h3>Số tiền: <span id="modalTongTien" class="text-success"></span></h3>
         </div>

   <div class="form-group">
            <label><strong>Phương thức thanh toán:</strong> <span class="text-danger">*</span></label>
             <select id="phuongThucThanhToan" class="form-control">
      <option value="0">Tiền mặt</option>
            <option value="1">Chuyển khoản</option>
        </select>
       </div>

     <div class="form-group" id="maGiaoDichGroup" style="display: none;">
   <label><strong>Mã giao dịch:</strong> <span class="text-danger">*</span></label>
        <input type="text" id="maGiaoDich" class="form-control" placeholder="Nhập mã giao dịch chuyển khoản" />
             </div>

           <input type="hidden" id="modalHoaDonId" />
         </div>
            <div class="modal-footer">
       <button type="button" class="btn btn-secondary" data-dismiss="modal">
           <i class="fas fa-times"></i> Hủy
              </button>
                <button type="button" class="btn btn-success" id="btnConfirmThanhToan">
   <i class="fas fa-check"></i> Xác nhận thanh toán
        </button>
         </div>
        </div>
    </div>
</div>

@* Anti-forgery token *@
@Html.AntiForgeryToken()

@section Scripts {
    <script>
        $(document).ready(function() {
          // Auto-hide alerts after 5 seconds
   setTimeout(function() {
     $('.alert:not(.dynamic-alert)').fadeOut('slow', function() {
   $(this).remove();
                });
            }, 5000);

  // Show/hide mã giao dịch based on phương thức
   $('#phuongThucThanhToan').on('change', function() {
      if ($(this).val() == '1') {
     $('#maGiaoDichGroup').show();
        } else {
     $('#maGiaoDichGroup').hide();
        $('#maGiaoDich').val('');
     }
  });

      // Confirm thanh toán
         $('#btnConfirmThanhToan').on('click', function() {
         var hoaDonId = $('#modalHoaDonId').val();
                var phuongThuc = $('#phuongThucThanhToan').val();
  var maGiaoDich = $('#maGiaoDich').val();

    if (phuongThuc == '1' && !maGiaoDich) {
        alert('Vui lòng nhập mã giao dịch!');
      return;
    }

   $.ajax({
  url: '@Url.Action("ThanhToan", "HoaDon")',
       type: 'POST',
     data: {
          __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
      hoaDonId: hoaDonId,
    phuongThuc: phuongThuc,
      maGiaoDich: maGiaoDich
            },
            success: function(response) {
            if (response.success) {
      showNotification('success', response.message);
            $('#thanhToanModal').modal('hide');
              setTimeout(function() { location.reload(); }, 1500);
           } else {
       showNotification('error', response.message);
    }
         },
      error: function() {
                 showNotification('error', 'Có lỗi xảy ra khi thanh toán!');
    }
    });
            });
  });

  function showThanhToanModal(hoaDonId, maHoaDon, tongTien) {
         $('#modalHoaDonId').val(hoaDonId);
    $('#modalMaHoaDon').text(maHoaDon);
            $('#modalTongTien').text(tongTien.toLocaleString('vi-VN') + 'đ');
            $('#phuongThucThanhToan').val('0');
          $('#maGiaoDichGroup').hide();
            $('#maGiaoDich').val('');
          $('#thanhToanModal').modal('show');
      }

        function showNotification(type, message) {
 var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
   var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

            var alertHtml = `
      <div class="alert ${alertClass} alert-dismissible fade show dynamic-alert" role="alert">
       <i class="fas ${icon}"></i> ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
     <span aria-hidden="true">&times;</span>
           </button>
    </div>
     `;

            $('.container-fluid').prepend(alertHtml);

            setTimeout(function() {
      $('.dynamic-alert').fadeOut('slow', function() {
   $(this).remove();
         });
     }, 5000);
        }
    </script>
}
