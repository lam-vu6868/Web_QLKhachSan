@model Web_QLKhachSan.Areas.NhanVienLeTan.ViewModels.SoDoPhongViewModel
@{
    ViewBag.Title = "Sơ Đồ Phòng";
    Layout = "~/Areas/NhanVienLeTan/Views/Shared/_LayoutNVLT.cshtml";
}

@section styles {
    <!-- Custom CSS for Sơ Đồ Phòng -->
    <link href="@Url.Content("~/Areas/NhanVienLeTan/assets/css/sodoPhong.css")" rel="stylesheet" />
}

<div class="container-fluid">
 @* ==== THỐNG KÊ NHANH ==== *@
    <div class="row mb-4">
 <div class="col-md-2 col-sm-6 mb-3">
        <div class="card border-left-primary shadow h-100 py-2">
  <div class="card-body">
             <div class="row no-gutters align-items-center">
    <div class="col mr-2">
 <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Tổng phòng</div>
         <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TongSoPhong</div>
      </div>
                   <div class="col-auto">
              <i class="fas fa-door-closed fa-2x text-gray-300"></i>
          </div>
        </div>
         </div>
            </div>
        </div>

        <div class="col-md-2 col-sm-6 mb-3">
      <div class="card border-left-success shadow h-100 py-2">
    <div class="card-body">
   <div class="row no-gutters align-items-center">
      <div class="col mr-2">
          <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Phòng trống</div>
     <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.SoPhongTrong</div>
         </div>
             <div class="col-auto">
     <i class="fas fa-door-open fa-2x text-gray-300"></i>
  </div>
       </div>
    </div>
       </div>
        </div>

        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card border-left-warning shadow h-100 py-2">
       <div class="card-body">
   <div class="row no-gutters align-items-center">
          <div class="col mr-2">
<div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Đã đặt</div>
<div class="h5 mb-0 font-weight-bold text-gray-800">@Model.SoPhongDaDat</div>
             </div>
         <div class="col-auto">
          <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
    </div>
           </div>
        </div>
            </div>
        </div>

     <div class="col-md-2 col-sm-6 mb-3">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
         <div class="row no-gutters align-items-center">
         <div class="col mr-2">
     <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Đang ở</div>
    <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.SoPhongDangO</div>
  </div>
    <div class="col-auto">
             <i class="fas fa-user fa-2x text-gray-300"></i>
            </div>
      </div>
       </div>
            </div>
     </div>

    <div class="col-md-2 col-sm-6 mb-3">
    <div class="card border-left-info shadow h-100 py-2">
       <div class="card-body">
  <div class="row no-gutters align-items-center">
   <div class="col mr-2">
          <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Đang dọn</div>
 <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.SoPhongDangDon</div>
             </div>
            <div class="col-auto">
 <i class="fas fa-broom fa-2x text-gray-300"></i>
        </div>
      </div>
            </div>
    </div>
        </div>

        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card border-left-secondary shadow h-100 py-2">
   <div class="card-body">
         <div class="row no-gutters align-items-center">
       <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">Tỷ lệ lấp đầy</div>
      <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TyLeLayDay%</div>
            </div>
  <div class="col-auto">
    <i class="fas fa-chart-pie fa-2x text-gray-300"></i>
         </div>
          </div>
   </div>
      </div>
        </div>
    </div>

    @* ==== FILTERS ==== *@
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
       <h6 class="m-0 font-weight-bold text-primary">
      <i class="fas fa-filter"></i> Bộ lọc
     </h6>
    </div>
 <div class="card-body">
       @using (Html.BeginForm("Index", "SoDoPhong", FormMethod.Get, new { @class = "form-inline" }))
       {
     <div class="form-group mr-3 mb-2">
      <label class="mr-2">Tầng:</label>
        @Html.DropDownList("locTheoTang",
               new SelectList(Model.DanhSachTang, Model.LocTheoTang),
          "-- Tất cả --",
           new { @class = "form-control" })
    </div>

      <div class="form-group mr-3 mb-2">
         <label class="mr-2">Trạng thái:</label>
          @Html.DropDownList("locTheoTrangThai",
    new SelectList(new[]
            {
       new { Value = (byte)0, Text = "Trống" },
         new { Value = (byte)1, Text = "Đã đặt" },
      new { Value = (byte)2, Text = "Đang ở" },
 new { Value = (byte)3, Text = "Đang dọn" },
         new { Value = (byte)4, Text = "Bảo trì" }
   }, "Value", "Text", Model.LocTheoTrangThai),
     "-- Tất cả --",
   new { @class = "form-control" })
     </div>

                <div class="form-group mr-3 mb-2">
       <label class="mr-2">Loại phòng:</label>
        @Html.DropDownList("locTheoLoaiPhong",
      new SelectList(Model.DanhSachLoaiPhong, "LoaiPhongId", "TenLoai", Model.LocTheoLoaiPhong),
   "-- Tất cả --",
          new { @class = "form-control" })
           </div>

       <div class="form-group mr-3 mb-2">
           <label class="mr-2">Tìm kiếm:</label>
          @Html.TextBox("timKiem", Model.TimKiem, new { @class = "form-control", placeholder = "Mã phòng, tên phòng..." })
   </div>

      <button type="submit" class="btn btn-primary mb-2 mr-2">
            <i class="fas fa-search"></i> Lọc
             </button>

       <a href="@Url.Action("Index", "SoDoPhong")" class="btn btn-secondary mb-2">
              <i class="fas fa-sync-alt"></i> Làm mới
     </a>
 }
        </div>
    </div>

    @* ==== SƠ ĐỒ PHÒNG THEO TẦNG ==== *@
    @if (Model.DanhSachPhong != null && Model.DanhSachPhong.Any())
    {
        foreach (var tang in Model.PhongTheoTang.OrderBy(t => t.Key))
        {
          <div class="card shadow mb-4">
      <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
     <i class="fas fa-building"></i> Tầng @tang.Key
 <span class="badge badge-secondary ml-2">@tang.Value.Count phòng</span>
       </h6>
                </div>
    <div class="card-body">
             <div class="row">
             @foreach (var phong in tang.Value)
        {
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-3">
       <div class="card room-card h-100 shadow-sm" 
 style="border-left: 4px solid @phong.TrangThaiPhongColor; cursor: pointer;"
      onclick="xemChiTietPhong(@phong.PhongId)">
         <div class="card-body p-3">
<div class="d-flex justify-content-between align-items-center mb-2">
     <h5 class="mb-0 font-weight-bold">@phong.MaPhong</h5>
     <i class="fas @phong.TrangThaiPhongIcon fa-lg" style="color: @phong.TrangThaiPhongColor"></i>
       </div>
           <p class="mb-1 small text-muted">@phong.TenLoaiPhong</p>
        <span class="badge badge-pill" style="background-color: @phong.TrangThaiPhongColor; color: white;">
              @phong.TrangThaiPhongText
    </span>

            @if (!string.IsNullOrEmpty(phong.TenKhach))
       {
 <div class="mt-2 pt-2 border-top">
    <p class="mb-1 small"><i class="fas fa-user"></i> @phong.TenKhach</p>
          @if (phong.CheckOutHomNay)
           {
          <span class="badge badge-warning">Check-out hôm nay</span>
               }
        </div>
               }

  @if (phong.CoYeuCauDacBiet)
 {
       <div class="mt-1">
     <i class="fas fa-exclamation-circle text-warning" title="Có yêu cầu đặc biệt"></i>
     </div>
              }
                </div>
  </div>
         </div>
  }
     </div>
      </div>
         </div>
        }
    }
    else
    {
      <div class="alert alert-info">
       <i class="fas fa-info-circle"></i> Không có phòng nào phù hợp với điều kiện lọc.
        </div>
    }
</div>

@* ==== MODAL CHI TIẾT PHÒNG ==== *@
<div class="modal fade" id="modalChiTietPhong" tabindex="-1" role="dialog" aria-labelledby="modalChiTietPhongLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
     <div class="modal-header">
       <h5 class="modal-title" id="modalChiTietPhongLabel">
    <i class="fas fa-door-open"></i> Chi tiết phòng
  </h5>
    </div>
 <div class="modal-body" id="modalBody">
  <div class="text-center">
            <div class="spinner-border text-primary" role="status">
   <span class="sr-only">Đang tải...</span>
    </div>
   <p class="mt-2">Đang tải thông tin phòng...</p>
  </div>
 </div>
   <div class="modal-footer">
         <button type="button" class="btn btn-secondary" data-dismiss="modal">
        <i class="fas fa-times"></i> Đóng
     </button>
 </div>
</div>
    </div>
</div>

@* ==== MODAL XÁC NHẬN CẬP NHẬT TRẠNG THÁI ==== *@
<div class="modal fade" id="modalXacNhan" tabindex="-1" role="dialog" aria-labelledby="modalXacNhanLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
    <div class="modal-header bg-warning text-white">
       <h5 class="modal-title" id="modalXacNhanLabel">
              <i class="fas fa-exclamation-triangle"></i> Xác nhận thay đổi
  </h5>
  <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
         <span aria-hidden="true">&times;</span>
           </button>
          </div>
            <div class="modal-body text-center py-4">
         <i class="fas fa-question-circle fa-3x text-warning mb-3"></i>
        <h5 class="mb-3">Bạn có chắc chắn muốn thay đổi trạng thái phòng này?</h5>
   <p class="text-muted">
          Trạng thái hiện tại: <strong id="trangThaiCu"></strong><br/>
              Trạng thái mới: <strong id="trangThaiMoiText"></strong>
    </p>
   </div>
   <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
   <i class="fas fa-times"></i> Hủy
    </button>
                <button type="button" class="btn btn-primary" id="btnXacNhanCapNhat">
            <i class="fas fa-check"></i> Xác nhận
                </button>
       </div>
        </div>
    </div>
</div>

@* ==== MODAL THÔNG BÁO KẾT QUẢ ==== *@
<div class="modal fade" id="modalThongBao" tabindex="-1" role="dialog" aria-labelledby="modalThongBaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-body text-center py-4" id="thongBaoBody">
          <!-- Nội dung động -->
    </div>
            <div class="modal-footer justify-content-center">
   <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">Đóng</button>
       </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Custom JS for Sơ Đồ Phòng -->
    <script src="@Url.Content("~/Areas/NhanVienLeTan/assets/js/sodoPhong.js")"></script>
    <script>
        // ✅ Đảm bảo modal đóng đúng cách
     $(document).ready(function() {
     // Đóng modal khi click nút Đóng
      $('#modalChiTietPhong [data-dismiss="modal"]').on('click', function() {
        $('#modalChiTietPhong').modal('hide');
   });

  // Đóng modal khi click bên ngoài
        $('#modalChiTietPhong').on('click', function(e) {
     if ($(e.target).is('#modalChiTietPhong')) {
        $(this).modal('hide');
       }
  });
        });

  // ✅ Hàm xem chi tiết phòng
        function xemChiTietPhong(phongId) {
 $('#modalChiTietPhong').modal('show');
  
     $('#modalBody').html(`
 <div class="text-center">
     <div class="spinner-border text-primary" role="status">
    <span class="sr-only">Đang tải...</span>
   </div>
 <p class="mt-2">Đang tải thông tin phòng...</p>
       </div>
   `);

 $.ajax({
    url: '@Url.Action("ChiTietPhong", "SoDoPhong")',
         type: 'GET',
      data: { phongId: phongId },
success: function(response) {
      if (response.success) {
     var phong = response.data;
          var html = `
       <div class="room-detail">
       <div class="row">
    <div class="col-md-6">
    <h6 class="font-weight-bold mb-3">Thông tin phòng</h6>
     <table class="table table-sm table-borderless">
       <tr>
           <td class="font-weight-bold">Mã phòng:</td>
      <td>${phong.MaPhong}</td>
    </tr>
     <tr>
   <td class="font-weight-bold">Tên phòng:</td>
   <td>${phong.TenPhong || 'N/A'}</td>
     </tr>
  <tr>
      <td class="font-weight-bold">Tầng:</td>
         <td>Tầng ${phong.Tang}</td>
     </tr>
     <tr>
<td class="font-weight-bold">Loại phòng:</td>
   <td>${phong.TenLoaiPhong}</td>
   </tr>
       <tr>
  <td class="font-weight-bold">Trạng thái:</td>
    <td>
       <span class="badge badge-pill" style="background-color: ${phong.TrangThaiPhongColor}; color: white;">
      ${phong.TrangThaiPhongText}
    </span>
 </td>
   </tr>
    <tr>
    <td class="font-weight-bold">Giá phòng:</td>
  <td class="text-danger font-weight-bold">${formatCurrency(phong.GiaPhong)}</td>
 </tr>
     </table>
   </div>
   <div class="col-md-6">
    <h6 class="font-weight-bold mb-3">Thông tin khách</h6>
   ${phong.TenKhach ? `
       <table class="table table-sm table-borderless">
         <tr>
   <td class="font-weight-bold">Tên khách:</td>
 <td>${phong.TenKhach}</td>
    </tr>
         <tr>
     <td class="font-weight-bold">SĐT:</td>
     <td>${phong.SoDienThoaiKhach || 'N/A'}</td>
             </tr>
     <tr>
   <td class="font-weight-bold">Check-in:</td>
     <td>${formatDate(phong.NgayCheckIn)}</td>
    </tr>
    <tr>
          <td class="font-weight-bold">Check-out:</td>
       <td>${formatDate(phong.NgayCheckOut)}</td>
        </tr>
  <tr>
        <td class="font-weight-bold">Số người:</td>
<td>${phong.SoNguoi} người</td>
      </tr>
    </table>
       ` : `
       <p class="text-muted">Phòng chưa có khách</p>
`}
      </div>
   </div>
  ${phong.GhiChu ? `
     <div class="mt-3">
 <h6 class="font-weight-bold">Ghi chú:</h6>
 <p class="text-muted">${phong.GhiChu}</p>
   </div>
      ` : ''}
    
      <div class="mt-4 pt-3 border-top edit-status-section">
        <h6 class="font-weight-bold mb-3">
            <i class="fas fa-edit"></i> Chỉnh sửa trạng thái phòng
        </h6>
        <div class="row g-2">
        <div class="col-lg-8 col-md-7 col-12 mb-2">
       <label for="trangThaiMoi" class="form-label-custom">Trạng thái mới:</label>
         <select class="form-control form-select-custom" id="trangThaiMoi" data-trang-thai-cu="${phong.TrangThaiPhong}" data-trang-thai-cu-text="${phong.TrangThaiPhongText}">
              <option value="0" ${phong.TrangThaiPhong == 0 ? 'selected' : ''}>🟢 Trống</option>
                    <option value="1" ${phong.TrangThaiPhong == 1 ? 'selected' : ''}>🟡 Đã đặt</option>
         <option value="2" ${phong.TrangThaiPhong == 2 ? 'selected' : ''}>🔴 Đang ở</option>
            <option value="3" ${phong.TrangThaiPhong == 3 ? 'selected' : ''}>🔵 Đang dọn</option>
   <option value="4" ${phong.TrangThaiPhong == 4 ? 'selected' : ''}>⚫ Bảo trì</option>
      </select>
      </div>
    <div class="col-lg-4 col-md-5 col-12 mb-2">
        <label class="form-label-custom d-none d-md-block">&nbsp;</label>
         <button class="btn btn-primary btn-update-status" onclick="capNhatTrangThaiPhong(${phong.PhongId})">
           <i class="fas fa-save"></i> Cập nhật
        </button>
            </div>
        </div>
  </div>
</div>
     </div>
 `;
    $('#modalBody').html(html);
 } else {
 $('#modalBody').html(`
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle"></i> ${response.message}
   </div>
`);
           }
     },
 error: function() {
         $('#modalBody').html(`
           <div class="alert alert-danger">
     <i class="fas fa-exclamation-triangle"></i> Không thể tải thông tin phòng. Vui lòng thử lại!
            </div>
    `);
   }
     });
 }

    // ✅ Biến toàn cục lưu phongId
        var currentPhongId = 0;

        // ✅ HÀM CẬP NHẬT TRẠNG THÁI PHÒNG
        function capNhatTrangThaiPhong(phongId) {
       var trangThaiMoi = $('#trangThaiMoi').val();
          var trangThaiCu = $('#trangThaiMoi').data('trang-thai-cu');
var trangThaiCuText = $('#trangThaiMoi').data('trang-thai-cu-text');
            var trangThaiMoiText = $('#trangThaiMoi option:selected').text();

    // Lưu phongId để dùng trong modal xác nhận
     currentPhongId = phongId;

            // Hiển thị thông tin trong modal xác nhận
        $('#trangThaiCu').text(trangThaiCuText).css('color', getTrangThaiColor(trangThaiCu));
         $('#trangThaiMoiText').text(trangThaiMoiText).css('color', getTrangThaiColor(trangThaiMoi));

            // Hiển thị modal xác nhận
          $('#modalXacNhan').modal('show');
        }

     // ✅ Xử lý khi click nút Xác nhận trong modal
        $(document).on('click', '#btnXacNhanCapNhat', function() {
        var trangThaiMoi = $('#trangThaiMoi').val();

       // Đóng modal xác nhận
   $('#modalXacNhan').modal('hide');

            // Gọi AJAX
   $.ajax({
            url: '@Url.Action("CapNhatTrangThai", "SoDoPhong")',
        type: 'POST',
data: { 
        phongId: currentPhongId, 
   trangThaiMoi: trangThaiMoi 
         },
        success: function(response) {
   if (response.success) {
    // Hiển thị thông báo thành công
      showThongBao('success', response.message);
        
  // Đóng modal chi tiết và reload sau 1.5s
       setTimeout(function() {
 $('#modalChiTietPhong').modal('hide');
          location.reload();
        }, 1500);
    } else {
            showThongBao('error', response.message);
   }
            },
      error: function() {
showThongBao('error', 'Không thể cập nhật trạng thái. Vui lòng thử lại!');
          }
            });
        });

        // ✅ Hàm hiển thị modal thông báo
        function showThongBao(type, message) {
       var icon = type === 'success' ? 'fa-check-circle text-success' : 'fa-times-circle text-danger';
    var html = `
        <i class="fas ${icon} fa-3x mb-3"></i>
      <h5>${message}</h5>
        `;
    $('#thongBaoBody').html(html);
    $('#modalThongBao').modal('show');
        }

     // ✅ Hàm lấy màu theo trạng thái
    function getTrangThaiColor(trangThai) {
            switch(parseInt(trangThai)) {
         case 0: return '#28a745'; // Trống - Xanh lá
      case 1: return '#ffc107'; // Đã đặt - Vàng
 case 2: return '#dc3545'; // Đang ở - Đỏ
    case 3: return '#17a2b8'; // Đang dọn - Xanh dương
     case 4: return '#6c757d'; // Bảo trì - Xám
      default: return '#000';
            }
   }

    // Helper functions
     function formatCurrency(value) {
if (!value) return 'N/A';
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
        }

     function formatDate(dateString) {
       if (!dateString) return 'N/A';
        var date = new Date(dateString);
   return date.toLocaleDateString('vi-VN');
  }
    </script>
}
