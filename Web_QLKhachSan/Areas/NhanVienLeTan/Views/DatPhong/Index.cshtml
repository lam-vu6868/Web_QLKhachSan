@model Web_QLKhachSan.Areas.NhanVienLeTan.ViewModels.DatPhong.DatPhongListViewModel
@{
    ViewBag.Title = "Quản Lý Đặt Phòng";
    Layout = "~/Areas/NhanVienLeTan/Views/Shared/_LayoutNVLT.cshtml";
}

@section styles {
    <!-- Custom CSS for Quản Lý Đặt Phòng -->
  <link href="@Url.Content("~/Areas/NhanVienLeTan/assets/css/datPhong.css")" rel="stylesheet" />
}

<div class="container-fluid">
    @* ==== HEADER ==== *@
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-check"></i> Quản Lý Đặt Phòng
        </h1>
  <a href="@Url.Action("Create", "DatPhong")" class="btn btn-primary btn-icon-split shadow-sm">
            <span class="icon text-white-50">
      <i class="fas fa-plus"></i>
            </span>
        <span class="text">Tạo Đơn Mới</span>
        </a>
    </div>

    @* ==== THÔNG BÁO ==== *@
    @if (TempData["SuccessMessage"] != null)
    {
<div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
<button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
       </button>
    </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
     <button type="button" class="close" data-dismiss="alert" aria-label="Close">
       <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @* ==== THỐNG KÊ NHANH ==== *@
    <div class="row mb-4">
 <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
<div class="card border-left-primary shadow h-100 py-2 stat-card">
 <div class="card-body">
    <div class="row no-gutters align-items-center">
    <div class="col mr-2">
        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Tổng đơn</div>
        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.TongDonDat</div>
 </div>
         <div class="col-auto">
      <i class="fas fa-list"></i>
      </div>
    </div>
      </div>
  </div>
      </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
  <div class="card border-left-warning shadow h-100 py-2 stat-card">
          <div class="card-body">
    <div class="row no-gutters align-items-center">
       <div class="col mr-2">
     <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Chờ xác nhận</div>
 <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.ChoXacNhan</div>
         </div>
           <div class="col-auto">
<i class="fas fa-clock"></i>
  </div>
 </div>
</div>
  </div>
        </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
     <div class="card border-left-info shadow h-100 py-2 stat-card">
   <div class="card-body">
     <div class="row no-gutters align-items-center">
        <div class="col mr-2">
     <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Đã xác nhận</div>
    <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.DaXacNhan</div>
 </div>
    <div class="col-auto">
     <i class="fas fa-check-circle"></i>
      </div>
  </div>
   </div>
  </div>
    </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
     <div class="card border-left-success shadow h-100 py-2 stat-card">
     <div class="card-body">
      <div class="row no-gutters align-items-center">
  <div class="col mr-2">
      <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Đã check-in</div>
  <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.DaCheckIn</div>
   </div>
    <div class="col-auto">
  <i class="fas fa-door-open"></i>
        </div>
        </div>
   </div>
  </div>
    </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
 <div class="card border-left-danger shadow h-100 py-2 stat-card">
     <div class="card-body">
   <div class="row no-gutters align-items-center">
     <div class="col mr-2">
  <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Đã hủy</div>
     <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.DaHuy</div>
       </div>
      <div class="col-auto">
    <i class="fas fa-ban"></i>
    </div>
            </div>
 </div>
      </div>
    </div>

        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
          <div class="card border-left-secondary shadow h-100 py-2 stat-card">
         <div class="card-body">
             <div class="row no-gutters align-items-center">
      <div class="col mr-2">
  <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">Doanh thu</div>
     <div class="h6 mb-0 font-weight-bold text-gray-800">@Model.ThongKe.DoanhThuDuKien.ToString("N0")đ</div>
     </div>
  <div class="col-auto">
         <i class="fas fa-dollar-sign"></i>
   </div>
 </div>
       </div>
     </div>
    </div>
    </div>

    @* ==== BỘ LỌC ==== *@
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-gradient-primary">
         <h6 class="m-0 font-weight-bold text-white">
 <i class="fas fa-filter"></i> Bộ Lọc & Tìm Kiếm
        </h6>
        </div>
        <div class="card-body">
       @using (Html.BeginForm("Index", "DatPhong", FormMethod.Get, new { id = "filterForm" }))
    {
     <div class="filter-container">
          @* Row 1: Search - Full Width *@
       <div class="row mb-3">
         <div class="col-12">
        <label class="filter-label">
             <i class="fas fa-search text-primary"></i> Tìm kiếm
     </label>
 @Html.TextBox("TimKiem", Model.Filter.TimKiem, new { 
            @class = "form-control form-control-lg filter-search-input", 
    placeholder = "Nhập mã đơn, tên khách hàng, số điện thoại..." 
     })
  </div>
      </div>

  @* Row 2: Filter Fields - Responsive Grid *@
     <div class="row mb-3">
             <div class="col-lg-3 col-md-6 col-sm-6 mb-3 mb-lg-0">
     <label class="filter-label">
         <i class="fas fa-tasks text-primary"></i> Trạng thái đặt
   </label>
        @Html.DropDownList("TrangThaiDatPhong",
          new SelectList(new[]
  {
      new { Value = (byte)0, Text = "Chờ xác nhận" },
                new { Value = (byte)1, Text = "Đã xác nhận" },
   new { Value = (byte)2, Text = "Đã check-in" },
           new { Value = (byte)3, Text = "Đã check-out" },
         new { Value = (byte)4, Text = "Đã hủy" }
           }, "Value", "Text", Model.Filter.TrangThaiDatPhong),
  "-- Tất cả --",
       new { @class = "form-control filter-select" })
             </div>

        <div class="col-lg-3 col-md-6 col-sm-6 mb-3 mb-lg-0">
            <label class="filter-label">
      <i class="fas fa-credit-card text-primary"></i> Thanh toán
          </label>
              @Html.DropDownList("TrangThaiThanhToan",
            new SelectList(new[]
       {
        new { Value = (byte)0, Text = "Chưa thanh toán" },
   new { Value = (byte)1, Text = "TT 1 phần" },
    new { Value = (byte)2, Text = "Đã thanh toán" }
        }, "Value", "Text", Model.Filter.TrangThaiThanhToan),
         "-- Tất cả --",
        new { @class = "form-control filter-select" })
    </div>

  <div class="col-lg-3 col-md-6 col-sm-6 mb-3 mb-md-0">
    <label class="filter-label">
     <i class="far fa-calendar-alt text-primary"></i> Từ ngày
     </label>
     @Html.TextBox("TuNgay", Model.Filter.TuNgay?.ToString("yyyy-MM-dd"), new { 
   @class = "form-control filter-date", 
   type = "date" 
      })
          </div>

           <div class="col-lg-3 col-md-6 col-sm-6 mb-3 mb-md-0">
              <label class="filter-label">
         <i class="far fa-calendar-alt text-primary"></i> Đến ngày
              </label>
         @Html.TextBox("DenNgay", Model.Filter.DenNgay?.ToString("yyyy-MM-dd"), new { 
            @class = "form-control filter-date", 
     type = "date" 
     })
          </div>
       </div>

      @* Row 3: Action Buttons *@
      <div class="row">
        <div class="col-12">
  <div class="filter-actions">
            <button type="submit" class="btn btn-primary btn-filter">
             <i class="fas fa-search"></i> <span class="d-none d-sm-inline">Tìm kiếm</span>
       </button>
    <a href="@Url.Action("Index", "DatPhong")" class="btn btn-secondary btn-filter">
      <i class="fas fa-redo"></i> <span class="d-none d-sm-inline">Làm mới</span>
   </a>
          
                </div>
     </div>
   </div>
       </div>
   }
  </div>
    </div>

    @* ==== DANH SÁCH ĐƠN ĐẶT PHÒNG ==== *@
    <div class="card shadow mb-4">
        <div class="card-header py-3">
 <h6 class="m-0 font-weight-bold text-primary">
        <i class="fas fa-table"></i> Danh sách đơn đặt phòng
     <span class="badge badge-primary ml-2">@Model.TotalRecords đơn</span>
 </h6>
        </div>
  <div class="card-body">
@if (Model.DanhSachDatPhong != null && Model.DanhSachDatPhong.Any())
            {
          <div class="table-responsive">
          <table class="table table-bordered table-hover" width="100%" cellspacing="0">
       <thead class="thead-light">
            <tr>
     <th>Mã đơn</th>
    <th>Ngày đặt</th>
       <th>Khách hàng</th>
        <th>Phòng</th>
   <th>Check-in</th>
   <th>Check-out</th>
<th>Nhân viên</th>  @* ✅ THÊM CỘT MỚI *@
   <th>Khuyến mãi</th>  @* ✅ THÊM CỘT MỚI *@
   <th>Tổng tiền</th>
     <th>Trạng thái</th>
     <th>Thanh toán</th>
       <th>Thao tác</th>
      </tr>
     </thead>
     <tbody>
         @foreach (var item in Model.DanhSachDatPhong)
          {
<tr>
         <td>
  <strong>@item.MaDatPhong</strong>
   @if (item.LaDonOnline)
{
          <br /><small class="badge badge-info">Online</small>
      }
   </td>
        <td>
        <small>@item.NgayDat.ToString("dd/MM/yyyy")</small><br />
  <small class="text-muted">@item.NgayDat.ToString("HH:mm")</small>
    </td>
           <td>
     <strong>@item.TenKhachHienThi</strong><br />
       <small class="text-muted">@item.SoDienThoai</small>
         </td>
      <td>
           <small>@item.DanhSachLoaiPhong</small><br />
  @if (!string.IsNullOrEmpty(item.DanhSachPhong) && item.DanhSachPhong != "Chưa gán")
  {
  <small class="text-primary">@item.DanhSachPhong</small>
    }
  else
      {
         <small class="text-muted">Chưa gán phòng</small>
             }
         </td>
     <td>
     @item.NgayNhan.ToString("dd/MM/yyyy")
@if (item.CheckInHomNay)
 {
         <br /><span class="badge badge-success">Hôm nay</span>
     }
      </td>
    <td>
   @item.NgayTra.ToString("dd/MM/yyyy")
          @if (item.CheckOutHomNay)
         {
           <br /><span class="badge badge-warning">Hôm nay</span>
       }
     </td>
    @* ✅ CỘT NHÂN VIÊN MỚI *@
         <td>
                @if (!string.IsNullOrEmpty(item.TenNhanVien))
    {
               <small class="text-muted">
           <i class="fas fa-user"></i> @item.TenNhanVien
      </small>
   }
                else
      {
        <small class="text-muted">-</small>
         }
            </td>
        @* ✅ CỘT KHUYẾN MÃI MỚI *@
  <td>
       @if (!string.IsNullOrEmpty(item.TenKhuyenMai))
    {
    <span class="badge badge-success" title="@item.MaKhuyenMaiCode">
            <i class="fas fa-tag"></i> @item.TenKhuyenMai
  </span>
         if (item.GiaTriKhuyenMai.HasValue && item.GiaTriKhuyenMai.Value > 0)
{
 <br /><small class="text-success">-@item.GiaTriKhuyenMai%</small>
      }
    }
       else
         {
      <small class="text-muted">-</small>
       }
   </td>
   <td class="text-right">
         <strong class="text-danger">@((item.TongTien ?? 0).ToString("N0"))đ</strong>
 </td>
             <td>
 <span class="badge badge-status" style="background-color: @item.TrangThaiDatPhongColor; color: white;">
     @item.TrangThaiDatPhongText
       </span>
    </td>
    <td>
     <span class="badge badge-status" style="background-color: @item.TrangThaiThanhToanColor; color: white;">
   @item.TrangThaiThanhToanText
    </span>
     </td>
        <td class="action-buttons text-center">
   <a href="@Url.Action("Details", new { id = item.DatPhongId })" class="btn btn-sm btn-info" title="Xem chi tiết">
       <i class="fas fa-eye"></i>
          </a>
    @if (item.TrangThaiDatPhong == 0)
   {
       <button type="button" class="btn btn-sm btn-success" onclick="xacNhanDon(@item.DatPhongId)" title="Xác nhận">
   <i class="fas fa-check"></i>
  </button>
    }
    @if (item.TrangThaiDatPhong < 2)
          {
    <button type="button" class="btn btn-sm btn-danger" onclick="huyDon(@item.DatPhongId)" title="Hủy đơn">
 <i class="fas fa-times"></i>
    </button>
        }
         </td>
      </tr>
       }
  </tbody>
     </table>
 </div>

    @* ==== PAGINATION ==== *@
   if (Model.TotalPages > 1)
          {
        <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
      <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
     <a class="page-link" href="@Url.Action("Index", new { 
           TimKiem = Model.Filter.TimKiem,
     TrangThaiDatPhong = Model.Filter.TrangThaiDatPhong,
            TrangThaiThanhToan = Model.Filter.TrangThaiThanhToan,
      TuNgay = Model.Filter.TuNgay?.ToString("yyyy-MM-dd"),
            DenNgay = Model.Filter.DenNgay?.ToString("yyyy-MM-dd"),
    CurrentPage = Model.CurrentPage - 1 
    })">
   <i class="fas fa-chevron-left"></i> Trước
      </a>
 </li>

         @for (int i = 1; i <= Model.TotalPages; i++)
    {
           <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
           <a class="page-link" href="@Url.Action("Index", new { 
           TimKiem = Model.Filter.TimKiem,
          TrangThaiDatPhong = Model.Filter.TrangThaiDatPhong,
         TrangThaiThanhToan = Model.Filter.TrangThaiThanhToan,
                    TuNgay = Model.Filter.TuNgay?.ToString("yyyy-MM-dd"),
      DenNgay = Model.Filter.DenNgay?.ToString("yyyy-MM-dd"),
    CurrentPage = i 
      })">@i</a>
       </li>
     }

<li class="page-item @(Model.HasNextPage ? "" : "disabled")">
  <a class="page-link" href="@Url.Action("Index", new { 
     TimKiem = Model.Filter.TimKiem,
     TrangThaiDatPhong = Model.Filter.TrangThaiDatPhong,
 TrangThaiThanhToan = Model.Filter.TrangThaiThanhToan,
     TuNgay = Model.Filter.TuNgay?.ToString("yyyy-MM-dd"),
     DenNgay = Model.Filter.DenNgay?.ToString("yyyy-MM-dd"),
     CurrentPage = Model.CurrentPage + 1 
    })">
    Sau <i class="fas fa-chevron-right"></i>
  </a>
</li>
           </ul>
                    </nav>

       <p class="text-center text-muted">
     Trang @Model.CurrentPage / @Model.TotalPages - Tổng @Model.TotalRecords đơn
          </p>
 }
       }
   else
    {
        <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Không có đơn đặt phòng nào phù hợp với điều kiện lọc.
          </div>
            }
 </div>
    </div>
</div>

@* ==== MODAL XÁC NHẬN ==== *@
<div class="modal fade" id="modalXacNhan" tabindex="-1" role="dialog" aria-labelledby="modalXacNhanLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
     <h5 class="modal-title" id="modalXacNhanLabel">
       <i class="fas fa-check-circle"></i> Xác nhận đơn đặt phòng
 </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
     <span aria-hidden="true">&times;</span>
         </button>
            </div>
         <div class="modal-body text-center py-4">
    <i class="fas fa-question-circle fa-3x text-success mb-3"></i>
<h5 class="mb-3">Bạn có chắc chắn muốn xác nhận đơn đặt phòng này?</h5>
      <p class="text-muted">Trạng thái sẽ chuyển sang "Đã xác nhận"</p>
  </div>
       <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
    <i class="fas fa-times"></i> Hủy
      </button>
       <button type="button" class="btn btn-success" id="btnXacNhanDon">
 <i class="fas fa-check"></i> Xác nhận
  </button>
    </div>
        </div>
</div>
</div>

@* ==== MODAL HỦY ĐƠN ==== *@
<div class="modal fade" id="modalHuyDon" tabindex="-1" role="dialog" aria-labelledby="modalHuyDonLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
   <div class="modal-content">
            <div class="modal-header bg-danger text-white">
       <h5 class="modal-title" id="modalHuyDonLabel">
          <i class="fas fa-ban"></i> Hủy đơn đặt phòng
           </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
       <span aria-hidden="true">&times;</span>
           </button>
            </div>
     <div class="modal-body">
 <div class="text-center mb-3">
          <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
     <h5 class="mt-3">Bạn có chắc chắn muốn hủy đơn này?</h5>
        </div>
  <div class="form-group">
   <label for="lyDoHuy">Lý do hủy:</label>
  <textarea class="form-control" id="lyDoHuy" rows="3" placeholder="Nhập lý do hủy đơn..."></textarea>
                </div>
            </div>
         <div class="modal-footer justify-content-center">
   <button type="button" class="btn btn-secondary" data-dismiss="modal">
         <i class="fas fa-times"></i> Đóng
        </button>
     <button type="button" class="btn btn-danger" id="btnHuyDon">
    <i class="fas fa-ban"></i> Xác nhận hủy
     </button>
  </div>
 </div>
    </div>
</div>

@section Scripts {
    <script>
    var currentDatPhongId = 0;

        // Xác nhận đơn
        function xacNhanDon(datPhongId) {
     currentDatPhongId = datPhongId;
         $('#modalXacNhan').modal('show');
        }

$('#btnXacNhanDon').on('click', function() {
          $.ajax({
           url: '@Url.Action("XacNhan", "DatPhong")',
 type: 'POST',
       data: { 
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
   id: currentDatPhongId 
       },
         success: function(response) {
             $('#modalXacNhan').modal('hide');
    if (response.success) {
  showNotification('success', response.message || 'Xác nhận đơn thành công!');
      setTimeout(function() { location.reload(); }, 1500);
 } else {
    showNotification('error', response.message || 'Có lỗi xảy ra!');
        }
    },
    error: function() {
       $('#modalXacNhan').modal('hide');
        showNotification('error', 'Không thể xác nhận đơn. Vui lòng thử lại!');
     }
      });
        });

        // Hủy đơn
        function huyDon(datPhongId) {
     currentDatPhongId = datPhongId;
            $('#lyDoHuy').val('');
   $('#modalHuyDon').modal('show');
        }

        $('#btnHuyDon').on('click', function() {
       var lyDo = $('#lyDoHuy').val().trim();
        if (!lyDo) {
       alert('Vui lòng nhập lý do hủy đơn!');
      return;
            }

      $.ajax({
     url: '@Url.Action("Huy", "DatPhong")',
                type: 'POST',
  data: { 
 __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
         id: currentDatPhongId,
     lyDo: lyDo
             },
      success: function(response) {
  $('#modalHuyDon').modal('hide');
       if (response.success) {
        showNotification('success', response.message || 'Hủy đơn thành công!');
           setTimeout(function() { location.reload(); }, 1500);
               } else {
         showNotification('error', response.message || 'Có lỗi xảy ra!');
        }
     },
      error: function() {
   $('#modalHuyDon').modal('hide');
   showNotification('error', 'Không thể hủy đơn. Vui lòng thử lại!');
  }
            });
        });

        // Hiển thị thông báo
     function showNotification(type, message) {
       var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
        
          var alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas ${icon}"></i> ${message}
         <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
       </button>
                </div>
            `;
            
     $('.container-fluid').prepend(alertHtml);
        }

        // Auto-hide alerts after 5 seconds
        $(document).ready(function() {
 setTimeout(function() {
                $('.alert').fadeOut('slow');
    }, 5000);
 });
    </script>
}
