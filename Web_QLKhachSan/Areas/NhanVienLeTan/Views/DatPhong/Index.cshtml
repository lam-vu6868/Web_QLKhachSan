@model Web_QLKhachSan.Areas.NhanVienLeTan.ViewModels.DatPhong.DatPhongListViewModel
@{
    ViewBag.Title = "Quản Lý Đặt Phòng";
    Layout = "~/Areas/NhanVienLeTan/Views/Shared/_LayoutNVLT.cshtml";
}

@section styles {
    <link href="@Url.Content("~/Areas/NhanVienLeTan/assets/css/datphong.css")" rel="stylesheet" />
}

<div class="container-fluid">
    @* ==== HEADER ==== *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
        <h2 class="mb-0"><i class="fas fa-calendar-alt"></i> Quản Lý Đặt Phòng</h2>
        <nav aria-label="breadcrumb">
     <ol class="breadcrumb bg-transparent p-0 mb-0">
                 <li class="breadcrumb-item"><a href="@Url.Action("Index", "DashboardNVLT")">Dashboard</a></li>
           <li class="breadcrumb-item active">Đặt Phòng</li>
       </ol>
            </nav>
        </div>
        <a href="@Url.Action("Create")" class="btn btn-primary btn-lg">
            <i class="fas fa-plus"></i> Tạo Đơn Mới
        </a>
    </div>

    @* ==== THỐNG KÊ NHANH ==== *@
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="stat-card bg-primary">
                <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
      <div class="stat-content">
    <div class="stat-value">@Model.ThongKe.TongDonDat</div>
           <div class="stat-label">Tổng Đơn</div>
     </div>
     </div>
    </div>
        <div class="col-md-3 mb-3">
 <div class="stat-card bg-warning">
         <div class="stat-icon"><i class="fas fa-clock"></i></div>
   <div class="stat-content">
        <div class="stat-value">@Model.ThongKe.ChoXacNhan</div>
         <div class="stat-label">Chờ Xác Nhận</div>
    </div>
            </div>
        </div>
   <div class="col-md-3 mb-3">
      <div class="stat-card bg-info">
     <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
       <div class="stat-content">
   <div class="stat-value">@Model.ThongKe.DaXacNhan</div>
            <div class="stat-label">Đã Xác Nhận</div>
     </div>
      </div>
     </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card bg-success">
         <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
          <div class="stat-content">
           <div class="stat-value">@((Model.ThongKe.DoanhThuDuKien / 1000000).ToString("F1"))tr</div>
          <div class="stat-label">Doanh Thu Dự Kiến</div>
          </div>
       </div>
        </div>
    </div>

    @* ==== BỘ LỌC ==== *@
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-filter"></i> Bộ Lọc</h6>
    </div>
        <div class="card-body">
      @using (Html.BeginForm("Index", "DatPhong", FormMethod.Get))
     {
     <div class="row">
      <div class="col-md-3 mb-2">
            @Html.TextBoxFor(m => m.Filter.TimKiem, new { @class = "form-control", placeholder = "Tìm mã đơn, tên khách, SĐT..." })
  </div>
 <div class="col-md-2 mb-2">
             @Html.DropDownListFor(m => m.Filter.TrangThaiDatPhong, 
      new SelectList(new[] {
            new { Value = "", Text = "-- Tất cả trạng thái --" },
             new { Value = "0", Text = "Chờ xác nhận" },
          new { Value = "1", Text = "Đã xác nhận" },
  new { Value = "2", Text = "Đã check-in" },
        new { Value = "3", Text = "Đã check-out" },
          new { Value = "4", Text = "Đã hủy" }
        }, "Value", "Text"),
   new { @class = "form-control" })
       </div>
      <div class="col-md-2 mb-2">
     @Html.TextBoxFor(m => m.Filter.TuNgay, new { @class = "form-control", type = "date", placeholder = "Từ ngày" })
          </div>
          <div class="col-md-2 mb-2">
          @Html.TextBoxFor(m => m.Filter.DenNgay, new { @class = "form-control", type = "date", placeholder = "Đến ngày" })
    </div>
 <div class="col-md-3 mb-2">
       <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-search"></i> Tìm Kiếm</button>
           </div>
     </div>
            }
        </div>
    </div>

    @* ==== DANH SÁCH ĐẶT PHÒNG ==== *@
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
  <i class="fas fa-list"></i> Danh Sách Đơn Đặt Phòng 
      <span class="badge badge-primary">@Model.TotalRecords đơn</span>
  </h6>
        </div>
    <div class="card-body p-0">
       @if (Model.DanhSachDatPhong != null && Model.DanhSachDatPhong.Any())
    {
         <div class="table-responsive">
     <table class="table table-hover mb-0">
      <thead class="bg-light">
<tr>
      <th>Mã Đơn</th>
              <th>Khách Hàng</th>
    <th>Ngày Nhận - Trả</th>
          <th>Phòng</th>
<th>Tổng Tiền</th>
        <th>Trạng Thái</th>
      <th>Thao Tác</th>
       </tr>
     </thead>
      <tbody>
     @foreach (var item in Model.DanhSachDatPhong)
    {
         <tr>
     <td>
 <strong>@item.MaDatPhong</strong>
           <br /><small class="text-muted">@item.NgayDat.ToString("dd/MM/yyyy")</small>
     </td>
         <td>
       <div>@item.TenKhachHang</div>
      <small class="text-muted"><i class="fas fa-phone"></i> @item.SoDienThoai</small>
          </td>
   <td>
  <div><i class="fas fa-calendar-check text-success"></i> @(item.NgayNhan.HasValue ? item.NgayNhan.Value.ToString("dd/MM/yyyy") : "N/A")</div>
<div><i class="fas fa-calendar-times text-danger"></i> @(item.NgayTra.HasValue ? item.NgayTra.Value.ToString("dd/MM/yyyy") : "N/A")</div>
     <small class="badge badge-secondary">@(item.SoDem ?? 0) đêm</small>
  </td>
     <td>
     <div>@item.DanhSachLoaiPhong</div>
    <small class="text-muted">@item.DanhSachPhong</small>
    </td>
       <td>
     <strong class="text-primary">@(item.TongTien.HasValue ? item.TongTien.Value.ToString("N0") : "0") đ</strong>
      </td>
     <td>
  <span class="badge badge-custom" style="background-color: @item.TrangThaiDatPhongColor">
     @item.TrangThaiDatPhongText
     </span>
  <br />
    <small class="badge badge-custom" style="background-color: @item.TrangThaiThanhToanColor">
       @item.TrangThaiThanhToanText
    </small>
</td>
       <td>
          <div class="btn-group" role="group">
          <a href="@Url.Action("Details", new { id = item.DatPhongId })" 
    class="btn btn-sm btn-info" title="Xem chi tiết">
   <i class="fas fa-eye"></i>
 </a>
      @if (item.CanXacNhan)
   {
          <button type="button" class="btn btn-sm btn-success" 
     onclick="xacNhanDon(@item.DatPhongId)" title="Xác nhận">
    <i class="fas fa-check"></i>
     </button>
       }
          @if (item.CanHuy)
      {
    <button type="button" class="btn btn-sm btn-danger" 
onclick="huyDon(@item.DatPhongId)" title="Hủy">
    <i class="fas fa-times"></i>
 </button>
 }
   </div>
           </td>
            </tr>
    }
  </tbody>
        </table>
 </div>

    @* ==== PAGINATION ==== *@
   if (Model.TotalPages > 1)
    {
            <div class="card-footer">
    <nav>
                    <ul class="pagination justify-content-center mb-0">
          @if (Model.HasPreviousPage)
         {
    <li class="page-item">
      <a class="page-link" href="@Url.Action("Index", new { currentPage = Model.CurrentPage - 1 })">Trước</a>
        </li>
       }
         @for (int i = 1; i <= Model.TotalPages; i++)
        {
     <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
         <a class="page-link" href="@Url.Action("Index", new { currentPage = i })">@i</a>
 </li>
     }
       @if (Model.HasNextPage)
       {
          <li class="page-item">
   <a class="page-link" href="@Url.Action("Index", new { currentPage = Model.CurrentPage + 1 })">Sau</a>
          </li>
    }
             </ul>
    </nav>
            </div>
         }
       }
       else
       {
         <div class="empty-state py-5">
            <i class="fas fa-inbox fa-3x mb-3"></i>
       <p>Chưa có đơn đặt phòng nào</p>
              <a href="@Url.Action("Create")" class="btn btn-primary">
       <i class="fas fa-plus"></i> Tạo Đơn Mới
     </a>
        </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function xacNhanDon(id) {
     if (confirm('Bạn có chắc muốn xác nhận đơn đặt phòng này?')) {
 $.post('@Url.Action("XacNhan")', { id: id }, function(response) {
 if (response.success) {
       alert(response.message);
                   location.reload();
           } else {
            alert(response.message);
           }
    });
            }
}

     function huyDon(id) {
            var lyDo = prompt('Nhập lý do hủy đơn:');
      if (lyDo) {
          $.post('@Url.Action("Huy")', { id: id, lyDo: lyDo }, function(response) {
          if (response.success) {
  alert(response.message);
       location.reload();
               } else {
           alert(response.message);
     }
         });
   }
        }
    </script>
}
