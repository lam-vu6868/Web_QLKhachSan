@model List<Web_QLKhachSan.Models.Phong>
@{
    ViewBag.Title = "Phòng Nghỉ";
}
<link rel="stylesheet" href="~/assets/css/phong-nghi.css" />

<section class="page-header">
    <div class="container">
        <h1 data-aos="fade-right">Khám Phá Không Gian Nghỉ Dưỡng</h1>
        <p data-aos="fade-left">
            Tìm kiếm và lựa chọn không gian hoàn hảo cho kỳ nghỉ của bạn
        </p>
    </div>
</section>
<main class="main-content-area">
    <div data-aos="zoom-out-up" class="container page-layout">
        <aside class="filter-sidebar">
            <div class="filter-header">
                <h4><i class="fas fa-sliders-h"></i> Bộ Lọc Tìm Kiếm</h4>
                <span class="filter-toggle">
                    <i class="fas fa-chevron-down"></i>
                </span>
            </div>

            <div class="filter-content active">
                <div class="filter-content-inner">
                    <form id="filterForm" method="get" action="@Url.Action("Index", "PhongNghi")">
                        <div class="filter-groups-container">
                            <!-- Price Range Filter -->
                            <div class="filter-group">
                                <h5>
                                    <i class="fas fa-dollar-sign"></i> Khoảng giá 
                                    <span class="price-value" style="color: #d4af37; font-weight: bold;"></span>
                                </h5>
                                <div class="price-range-slider">
                                    @{
                                        // Mặc định là 0 (300k), nếu có filter thì dùng filter
                                        var selectedPriceLevel = ViewBag.PriceLevel ?? 0;
                                    }
                                    @* Slider với 4 mức giá: 0=300k, 1=400k, 2=600k, 3=900k *@
                                    <input type="range" min="0" max="3" value="@selectedPriceLevel" step="1" class="slider" id="priceRange" name="priceLevel" />
                                    <div class="price-display">
                                        <span>@((ViewBag.MinPrice ?? 300000).ToString("#,##0"))đ</span>
                                        <span>@((ViewBag.MaxPrice ?? 900000).ToString("#,##0"))đ</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Room Type Filter -->
                            <div class="filter-group">
                                <h5><i class="fas fa-bed"></i> Loại phòng</h5>
                                <div class="checkbox-group">
                                    @if (ViewBag.LoaiPhongs != null)
                                    {
                                        var selectedLoaiPhong = ViewBag.SelectedLoaiPhong as int[] ?? new int[0];
                                        foreach (var loaiPhong in (List<Web_QLKhachSan.Models.LoaiPhong>)ViewBag.LoaiPhongs)
                                        {
                                            var isChecked = selectedLoaiPhong.Contains(loaiPhong.LoaiPhongId);
                                            <label>
                                                <input type="checkbox" value="@loaiPhong.LoaiPhongId" name="loaiPhong" @(isChecked ? "checked" : "") />
                                                <span>@loaiPhong.TenLoai</span>
                                            </label>
                                        }
                                    }
                                </div>
                            </div>

                            <!-- Amenities Filter -->
                            <div class="filter-group">
                                <h5><i class="fas fa-concierge-bell"></i> Tiện ích</h5>
                                <div class="checkbox-group">
                                    @if (ViewBag.TienIches != null)
                                    {
                                        var selectedTienIch = ViewBag.SelectedTienIch as int[] ?? new int[0];
                                        foreach (var tienIch in (List<Web_QLKhachSan.Models.TienIch>)ViewBag.TienIches)
                                        {
                                            var isChecked = selectedTienIch.Contains(tienIch.TienIchId);
                                            <label>
                                                <input type="checkbox" value="@tienIch.TienIchId" name="tienIch" @(isChecked ? "checked" : "") />
                                                <span>@tienIch.TenTienIch</span>
                                            </label>
                                        }
                                    }
                                </div>
                            </div>

                            @* Hidden field để giữ sort *@
                            <input type="hidden" name="sort" value="@ViewBag.CurrentSort" />

                            <button type="submit" class="filter-apply-btn">
                                <i class="fas fa-search"></i>
                                Áp dụng bộ lọc
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </aside>

        <section class="room-listing-area">
            <div class="listing-header">
                <p>Hiển thị <strong>@(Model?.Count ?? 0)</strong> / <strong>@(ViewBag.TotalItems ?? 0)</strong> phòng nghỉ tuyệt vời</p>
                <select name="sort" id="sort" onchange="handleSortChange(this)">
                    <option value="default" @(ViewBag.CurrentSort == "default" ? "selected" : "")>Sắp xếp mặc định</option>
                    <option value="price-asc" @(ViewBag.CurrentSort == "price-asc" ? "selected" : "")>Giá: Thấp đến Cao</option>
                    <option value="price-desc" @(ViewBag.CurrentSort == "price-desc" ? "selected" : "")>Giá: Cao đến Thấp</option>
                </select>
            </div>

            <div class="room-listing-grid">
                @if (Model != null && Model.Any())
                {
                    foreach (var phong in Model)
                    {
                        <div class="room-item">
                            <div class="room-item-image">
                                @if (!string.IsNullOrEmpty(phong.HinhAnhThumb))
                                {
                                    <img src="@phong.HinhAnhThumb" alt="@phong.TenPhong" />
                                }
                                else if (phong.PhongAnhs != null && phong.PhongAnhs.Any())
                                {
                                    <img src="@phong.PhongAnhs.FirstOrDefault().Url" alt="@phong.TenPhong" />
                                }
                                else
                                {
                                    <img src="https://images.unsplash.com/photo-1611892440504-42a792e24d32?auto=format&fit=crop&w=870&q=80" alt="@phong.TenPhong" />
                                }
                                
                                @* Icon trạng thái phòng *@
                                @{
                                    string statusClass = "";
                                    string statusIcon = "";
                                    string statusText = "";
                                    
                                    switch (phong.TrangThaiPhong)
                                    {
                                        case 0: // Trống
                                            statusClass = "status-available";
                                            statusIcon = "fas fa-check-circle";
                                            statusText = "Trống";
                                            break;
                                        case 1: // Đã đặt
                                            statusClass = "status-booked";
                                            statusIcon = "fas fa-calendar-check";
                                            statusText = "Đã đặt";
                                            break;
                                        case 2: // Đang ở
                                            statusClass = "status-occupied";
                                            statusIcon = "fas fa-user-check";
                                            statusText = "Đang ở";
                                            break;
                                        case 3: // Đang dọn
                                            statusClass = "status-cleaning";
                                            statusIcon = "fas fa-broom";
                                            statusText = "Đang dọn";
                                            break;
                                        case 4: // Bảo trì
                                            statusClass = "status-maintenance";
                                            statusIcon = "fas fa-tools";
                                            statusText = "Bảo trì";
                                            break;
                                        default:
                                            statusClass = "status-unknown";
                                            statusIcon = "fas fa-question-circle";
                                            statusText = "N/A";
                                            break;
                                    }
                                }
                                <div class="room-status-badge @statusClass">
                                    <i class="@statusIcon"></i>
                                    <span>@statusText</span>
                                </div>
                                
                                <div class="tag">@phong.LoaiPhong.TenLoai</div>
                            </div>
                            <div class="room-item-content">
                                <h3>@phong.TenPhong</h3>
                                <p class="price">@((phong.Gia ?? phong.LoaiPhong.GiaCoBan ?? 0).ToString("#,##0"))₫ <span>/ đêm</span></p>
                                <p class="description">
                                    @(phong.LoaiPhong.MoTa ?? "Phòng nghỉ thoải mái với đầy đủ tiện nghi hiện đại.")
                                    @if (phong.LoaiPhong.DienTich.HasValue)
                                    {
                                        <span>Diện tích: @phong.LoaiPhong.DienTich m².</span>
                                    }
                                    @if (phong.LoaiPhong.SoNguoiToiDa.HasValue)
                                    {
                                        <span>Tối đa @phong.LoaiPhong.SoNguoiToiDa người.</span>
                                    }
                                </p>
                                <div class="amenities-icons">
                                    @if (phong.LoaiPhong.TienIches != null && phong.LoaiPhong.TienIches.Any())
                                    {
                                        foreach (var tienIch in phong.LoaiPhong.TienIches.Take(6))
                                        {
                                            if (!string.IsNullOrEmpty(tienIch.Icon))
                                            {
                                                <i class="@tienIch.Icon" title="@tienIch.TenTienIch"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-check" title="@tienIch.TenTienIch"></i>
                                            }
                                        }
                                    }
                                    else
                                    {
                                        <i class="fas fa-wifi" title="Wifi miễn phí"></i>
                                        <i class="fas fa-bath" title="Bồn tắm"></i>
                                        <i class="fas fa-tv" title="TV màn hình phẳng"></i>
                                        <i class="fas fa-snowflake" title="Điều hòa"></i>
                                        <i class="fas fa-coffee" title="Minibar"></i>
                                        <i class="fas fa-bed" title="Giường thoải mái"></i>
                                    }
                                </div>
                                <div class="room-actions">
                                    <a href="@Url.Action("Index", "ChiTietPhong", new { id = phong.PhongId })" class="cta-button">Xem Chi Tiết</a>
                                    <div class="booking-btn-wrapper">
                                        <a href="@Url.Action("Index", "ThongTin", new { phongId = phong.PhongId })" class="btn-booking"></a>
                                        <span class="tooltip">Đặt Phòng Ngay</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="no-rooms-message">
                        <p>Hiện tại không có phòng nào khả dụng. Vui lòng quay lại sau.</p>
                    </div>
                }
            </div>

            @if (ViewBag.TotalPages > 1)
            {
                <div class="pagination">
                    @{
                        // Hàm helper để build URL với mảng parameters
                        Func<int, string> buildPaginationUrl = (pageNum) =>
                        {
                            var url = Url.Action("Index") + "?page=" + pageNum;
                            
                            if (ViewBag.CurrentSort != null && ViewBag.CurrentSort != "default")
                            {
                                url += "&sort=" + ViewBag.CurrentSort;
                            }
                            
                            if (ViewBag.PriceLevel != null)
                            {
                                url += "&priceLevel=" + ViewBag.PriceLevel;
                            }
                            
                            if (ViewBag.SelectedLoaiPhong != null)
                            {
                                foreach (int lp in ViewBag.SelectedLoaiPhong)
                                {
                                    url += "&loaiPhong=" + lp;
                                }
                            }
                            
                            if (ViewBag.SelectedTienIch != null)
                            {
                                foreach (int ti in ViewBag.SelectedTienIch)
                                {
                                    url += "&tienIch=" + ti;
                                }
                            }
                            
                            return url;
                        };
                    }
                    
                    @* Nút Previous *@
                    @if (ViewBag.CurrentPage > 1)
                    {
                        <a href="@buildPaginationUrl(ViewBag.CurrentPage - 1)">&laquo;</a>
                    }

                    @* Hiển thị các trang *@
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        if (i == ViewBag.CurrentPage)
                        {
                            <a href="@buildPaginationUrl(i)" class="active">@i</a>
                        }
                        else
                        {
                            <a href="@buildPaginationUrl(i)">@i</a>
                        }
                    }

                    @* Nút Next *@
                    @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                    {
                        <a href="@buildPaginationUrl(ViewBag.CurrentPage + 1)">&raquo;</a>
                    }
                </div>
            }
        </section>
    </div>
</main>

<script src="~/assets/js/phong-nghi.js"></script>
